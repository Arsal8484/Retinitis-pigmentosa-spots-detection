
close all
clear all
%  load 'mynet1'
  load 'netA1' %%%% netA1 for multifusion
% load 'adamnet'
 % load 'mynet3'
  newacc=0;
 dir_path = 'J:\9th\RIPS_Experiment\Fold1\Test';
file_name = sprintf('AccG1%d.txt',2);
out = fullfile(dir_path,file_name);
fileID = fopen(out,'w');
% fprintf(fileID,'\r\n');

 
%  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
for ff=1:30 %Arsal
    num=num2str(ff); % Arsal
    file=strcat(num,'.jpg'); % Arsal
    image = (imread(file));% Arsal
    im=image;
    imA=image;
      im = imresize(im,[480 720]);
        [x1,x2,x3]=size(image); 
        Scolor1=image;
         Scolor2=image;
   if x3==3
   image=rgb2gray(image);
   NEW_img=image;
   end
      Orig_image=image;    
      imu=image>200;
       imd=image<150;
%          im=im*0.8;
%        figure,imshow(im)
%        figure,imshow(imu)
%        figure,imshow(imd)
    tic;
       C = semanticseg(im,net);
      
toc;
 k=C=='P';
 k2=C=='NonP';
 
%  figure,imshow(k1)
mask=double(k);
mask2=double(k2);


m=mask;
m2=mask2;


 [labels_R1,scores_R1,allscores_R1] = semanticseg(im,net,'ExecutionEnvironment','gpu');

        xx= allscores_R1(:,:,1);
        newarr=zeros(size(xx));
        [lim1,lim2]=size(xx);
        for l1=1:lim1
            for l2=1:lim2
                
                if xx(l1,l2)<0.93
                    newarr(l1,l2)=1;
                end
                
            end
        end
         mask(newarr==1)=0;
  mask = imresize(mask,[1440 2160]);
%  BW= bwareafilt(logical(mask3),[1 100]);
% BW = imclearborder(mask3,26);
 

windowSize_l = 3;
kernel_l = ones(windowSize_l) / windowSize_l ^ 2;
m = conv2(single(m), kernel_l, 'same');
lImage = m > 0.30; % Rethreshold
% figure,imshow(hImage)
%  hImage = imfill(hImage,'holes');



 
%       mask=double(lImage);
%   figure,imshow(tImage)
% CC = bwconncomp(mask4,4);
% 
% numPixels = cellfun(@numel,CC.PixelIdxList);
% [biggest,idx] = max(numPixels);
% mask4(CC.PixelIdxList{idx}) = 0;

 
% mask2(k4==1)=0;
% mask2(k==1)=0;
%  mask(mask2==1)=0;

 rem1 = bwareaopen(logical(mask),500);
%          mask(rem1==1)=1;
 
%   figure,imshow(rem1)
% mask3(mask5==0)=0;
% figure,imshow(mask4)
%    figure,imshow(mask5)
   
%   mask6=mask5-mask; 
%    figure,imshow(mask6)
%    mask=medfilt2(mask,[3 3]);
%     mask2=medfilt2(mask2,[3 3]);
%      mask3=medfilt2(mask3,[3 3]);
%       mask4=medfilt2(mask4,[3 3]);
%   figure,imshow(mask2)
  se = strel('disk',3);
   se1 = strel('disk',2); 
 IM2 = imerode(mask,se);
%  mask3=imerode(mask3,se1);
%  figure,imshow(k)
%  mask=IM2;
%        B = labeloverlay(im,mask);
%     figure,imshow(B)
%       mask(mask6==1)=0;
%   figure,imshow(mask)
  Names = sprintf('%d%s',ff,'.png');
 Dri='J:\9th\RIPS_Experiment\Fold1\Test GT1\';

        
            
         Folder = fullfile(Dri,Names);
         GT=imread(Folder);  
            [l1,l2]=size(GT);
            
%             if l1>500
%                GT = imresize(GT,[300 400],'nearest');
%                 
%             end
%          GT=double(GT);
%          GT(k2==1)=0;
          
         imR=imA(:,:,1);
        imG=imA(:,:,2);
        imB=imA(:,:,3);
         [x1,y1]=size(imR);
         
        TSP=0;
         TNSP=0;
        
                for jjj=1:x1
                      for kkk=1:y1
                         if GT(jjj,kkk)==0   
                         TSP=TSP+1;
            
                         elseif GT(jjj,kkk)==255
                         TNSP=TNSP+1; 
             
                         end 
                      end
                end 
         
          err=0;
          tp=0;
          fp=0;
          fn=0;
          tn=0;
           tot=250*400;
   for jj=1:x1
        for kk=1:y1
        
            if GT(jj,kk)==1 && mask(jj,kk)==1
                 imR(jj,kk)=0;
                  imG(jj,kk)=0;
                   imB(jj,kk)=255;
                   tp=tp+1;
           elseif GT(jj,kk)==1 && mask(jj,kk)==0  %&& imd(jj,kk)==0 
               imR(jj,kk)=255;
               imG(jj,kk)=0;
               imB(jj,kk)=0;
               err=err+1;
               fn=fn+1;
            elseif GT(jj,kk)==0 && mask(jj,kk)==1 % && imd(jj,kk)==0 
          
              imR(jj,kk)=0;
              imG(jj,kk)=255;
              imB(jj,kk)=0;
              err=err+1;
              fp=fp+1;
              
            elseif GT(jj,kk)==0 && mask(jj,kk)==0
                
%                  imR(jj,kk)=0;
%                  imG(jj,kk)=0;
%                  imB(jj,kk)=0;
                 err=err+1;
                 tn=tn+1;
        
            end
            
            
            
        end
   end

   im1=cat(3,imR,imG,imB);
  
   P=(tp/(tp+fp)*100);
   R=(tp/(tp+fn))*100; %senstivity
   F=2*R*P;
   F=F/(R+P);
   
   
   DR=(tp/TSP)*100;
   
   FPR=(fp/TNSP)*100;
   
   FNR=(fn/TSP)*100;
   
   
   IOU=(tp/(tp+fp+fn)*100);
   
   FPR1=(fp/(fp+tn)*100);
   FNR1= (fn/(fn+tp)*100);
   
%    figure,imshow(im1)

     TPR=(tp/(tp+fn)*100);
     TNR=(tn/(tn+fp)*100); %Specificity

    TDE=FPR+FNR;
Acc=((tp+tn)/(tp+fp+fn+tn)*100);
newacc=(newacc+Acc);
ImgStoreName = sprintf('%dR.bmp',ff);
  imwrite(im1,ImgStoreName)
% Er=err/tot;
  fprintf(fileID,'%s\t%s\t%s\t%s\t%s\t%s\t%s\r\n',num2str(ff),num2str(R),num2str(TNR),num2str(P),num2str(F),num2str(Acc),num2str(IOU));


end


Accuracy = (newacc/25);
